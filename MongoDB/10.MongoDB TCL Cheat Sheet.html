<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MongoDB Cheat Sheet #10 - TCL (Transaction Control)</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      border-radius: 15px;
    }
    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    .header .subtitle {
      color: #2c3e50;
      font-size: 1.1em;
      opacity: 0.9;
    }
    .badge {
      display: inline-block;
      background: rgba(44,62,80,0.3);
      color: #fff;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85em;
      margin-top: 10px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(252,70,107,0.3);
    }
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #fc466b;
    }
    .card-icon {
      font-size: 1.8em;
      margin-right: 12px;
    }
    .card-title {
      font-size: 1.3em;
      color: #fee140;
    }
    .code-block {
      background: #0d1117;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      overflow-x: auto;
      border-left: 3px solid #fc466b;
    }
    .code-comment {
      color: #6a737d;
    }
    .code-keyword {
      color: #ff7b72;
    }
    .code-string {
      color: #a5d6ff;
    }
    .code-method {
      color: #d2a8ff;
    }
    .code-number {
      color: #79c0ff;
    }
    .code-bool {
      color: #ff7b72;
    }
    .code-prop {
      color: #7ee787;
    }
    .highlight {
      background: linear-gradient(135deg, rgba(252,70,107,0.2), rgba(63,94,251,0.2));
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
    }
    .list-item {
      padding: 8px 0;
      padding-left: 20px;
      position: relative;
    }
    .list-item::before {
      content: "‚ñ∏";
      position: absolute;
      left: 0;
      color: #fee140;
    }
    .tag {
      display: inline-block;
      background: rgba(252,70,107,0.2);
      color: #fee140;
      padding: 3px 10px;
      border-radius: 5px;
      font-size: 0.8em;
      margin: 2px;
    }
    .tag-blue {
      background: rgba(33,150,243,0.2);
      color: #64b5f6;
    }
    .tag-green {
      background: rgba(76,175,80,0.2);
      color: #81c784;
    }
    .tag-orange {
      background: rgba(255,152,0,0.2);
      color: #ffb74d;
    }
    .tag-red {
      background: rgba(244,67,54,0.2);
      color: #e57373;
    }
    .tag-purple {
      background: rgba(156,39,176,0.2);
      color: #ce93d8;
    }
    .full-width {
      grid-column: 1 / -1;
    }
    .info-box {
      background: rgba(33,150,243,0.1);
      border-left: 3px solid #2196f3;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .warning-box {
      background: rgba(244,67,54,0.1);
      border-left: 3px solid #f44336;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .tip-box {
      background: rgba(76,175,80,0.1);
      border-left: 3px solid #4caf50;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .section-title {
      color: #fee140;
      font-size: 1.1em;
      margin: 15px 0 10px 0;
      padding-bottom: 5px;
      border-bottom: 1px dashed rgba(254,225,64,0.3);
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .comparison-table th, .comparison-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .comparison-table th {
      background: rgba(252,70,107,0.2);
      color: #fee140;
    }
    .comparison-table tr:hover {
      background: rgba(255,255,255,0.05);
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }
    .example-box {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
    }
    .example-title {
      color: #fee140;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 0.9em;
    }
    .acid-box {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .acid-card {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      border-top: 3px solid;
    }
    .acid-card.a { border-color: #e74c3c; }
    .acid-card.c { border-color: #3498db; }
    .acid-card.i { border-color: #2ecc71; }
    .acid-card.d { border-color: #f39c12; }
    .acid-icon {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .acid-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .transaction-flow {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .flow-step {
      display: inline-block;
      background: linear-gradient(135deg, #fc466b, #3f5efb);
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      margin: 5px;
      font-weight: bold;
    }
    .flow-arrow {
      display: inline-block;
      color: #fee140;
      font-size: 1.5em;
      margin: 0 10px;
    }
    .footer {
      text-align: center;
      padding: 20px;
      color: rgba(255,255,255,0.5);
      font-size: 0.9em;
    }
    @media (max-width: 768px) {
      .acid-box {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üçÉ MongoDB Cheat Sheet #10</h1>
      <div class="subtitle">TCL - Transaction Control Language</div>
      <div class="badge">üí≥ ACID Transactions ‚Ä¢ Multi-Document ‚Ä¢ Sessions</div>
    </div>

    <!-- Transaction Overview -->
    <div class="grid">
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">üí≥</span>
          <span class="card-title">MongoDB Transactions Overview</span>
        </div>
        <div class="highlight">
          MongoDB h·ªó tr·ª£ <strong>Multi-Document ACID Transactions</strong> t·ª´ version 4.0+ (Replica Sets) v√† 4.2+ (Sharded Clusters)
        </div>
        
        <div class="acid-box">
          <div class="acid-card a">
            <div class="acid-icon">‚öõÔ∏è</div>
            <div class="acid-title" style="color: #e74c3c;">Atomicity</div>
            <div style="font-size: 0.85em;">All or Nothing<br>T·∫•t c·∫£ th√†nh c√¥ng ho·∫∑c t·∫•t c·∫£ rollback</div>
          </div>
          <div class="acid-card c">
            <div class="acid-icon">‚úÖ</div>
            <div class="acid-title" style="color: #3498db;">Consistency</div>
            <div style="font-size: 0.85em;">Valid State<br>D·ªØ li·ªáu lu√¥n ·ªü tr·∫°ng th√°i h·ª£p l·ªá</div>
          </div>
          <div class="acid-card i">
            <div class="acid-icon">üîí</div>
            <div class="acid-title" style="color: #2ecc71;">Isolation</div>
            <div style="font-size: 0.85em;">Concurrent Safe<br>Transactions ƒë·ªôc l·∫≠p v·ªõi nhau</div>
          </div>
          <div class="acid-card d">
            <div class="acid-icon">üíæ</div>
            <div class="acid-title" style="color: #f39c12;">Durability</div>
            <div style="font-size: 0.85em;">Persistent<br>D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u vƒ©nh vi·ªÖn</div>
          </div>
        </div>

        <table class="comparison-table">
          <tr>
            <th>Feature</th>
            <th>Single Document</th>
            <th>Multi-Document Transaction</th>
          </tr>
          <tr>
            <td><strong>ACID</strong></td>
            <td>‚úÖ Atomic by default</td>
            <td>‚úÖ Full ACID compliance</td>
          </tr>
          <tr>
            <td><strong>Performance</strong></td>
            <td>‚ö° Very fast</td>
            <td>üê¢ Slower (overhead)</td>
          </tr>
          <tr>
            <td><strong>Use Case</strong></td>
            <td>Most operations (99%)</td>
            <td>Complex multi-step operations</td>
          </tr>
          <tr>
            <td><strong>Requirements</strong></td>
            <td>Any MongoDB</td>
            <td>Replica Set or Sharded Cluster</td>
          </tr>
        </table>

        <div class="warning-box">
          ‚ö†Ô∏è <strong>Important:</strong> Transactions ch·ªâ ho·∫°t ƒë·ªông tr√™n <strong>Replica Sets</strong> ho·∫∑c <strong>Sharded Clusters</strong>, KH√îNG ho·∫°t ƒë·ªông tr√™n standalone MongoDB
        </div>
      </div>
    </div>

    <!-- Transaction Flow -->
    <div class="grid">
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">üîÑ</span>
          <span class="card-title">Transaction Lifecycle</span>
        </div>
        
        <div class="transaction-flow">
          <div class="flow-step">1. Start Session</div>
          <span class="flow-arrow">‚Üí</span>
          <div class="flow-step">2. Start Transaction</div>
          <span class="flow-arrow">‚Üí</span>
          <div class="flow-step">3. Execute Operations</div>
          <span class="flow-arrow">‚Üí</span>
          <div class="flow-step">4. Commit / Abort</div>
          <span class="flow-arrow">‚Üí</span>
          <div class="flow-step">5. End Session</div>
        </div>

        <div class="code-block">
          <span class="code-comment">// Transaction lifecycle</span><br>
          <span class="code-keyword">const</span> session = client.<span class="code-method">startSession</span>();<br><br>
          
          <span class="code-keyword">try</span> {<br>
          &nbsp;&nbsp;session.<span class="code-method">startTransaction</span>();<br><br>
          
          &nbsp;&nbsp;<span class="code-comment">// Perform operations within transaction</span><br>
          &nbsp;&nbsp;<span class="code-keyword">await</span> collection1.<span class="code-method">insertOne</span>(doc1, { session });<br>
          &nbsp;&nbsp;<span class="code-keyword">await</span> collection2.<span class="code-method">updateOne</span>(query, update, { session });<br><br>
          
          &nbsp;&nbsp;<span class="code-comment">// Commit if all successful</span><br>
          &nbsp;&nbsp;<span class="code-keyword">await</span> session.<span class="code-method">commitTransaction</span>();<br>
          } <span class="code-keyword">catch</span> (error) {<br>
          &nbsp;&nbsp;<span class="code-comment">// Abort on error</span><br>
          &nbsp;&nbsp;<span class="code-keyword">await</span> session.<span class="code-method">abortTransaction</span>();<br>
          } <span class="code-keyword">finally</span> {<br>
          &nbsp;&nbsp;<span class="code-keyword">await</span> session.<span class="code-method">endSession</span>();<br>
          }
        </div>
      </div>
    </div>

    <!-- mongosh Transactions -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üñ•Ô∏è</span>
          <span class="card-title">Transactions in mongosh</span>
        </div>
        
        <div class="section-title">Basic Transaction</div>
        <div class="code-block">
          <span class="code-comment">// 1. Start session</span><br>
          <span class="code-keyword">const</span> session = db.<span class="code-method">getMongo</span>().<span class="code-method">startSession</span>();<br><br>
          
          <span class="code-comment">// 2. Get database and collections</span><br>
          <span class="code-keyword">const</span> accountsDB = session.<span class="code-method">getDatabase</span>(<span class="code-string">"bank"</span>);<br>
          <span class="code-keyword">const</span> accounts = accountsDB.<span class="code-method">getCollection</span>(<span class="code-string">"accounts"</span>);<br><br>
          
          <span class="code-comment">// 3. Start transaction</span><br>
          session.<span class="code-method">startTransaction</span>();<br><br>
          
          <span class="code-comment">// 4. Execute operations</span><br>
          accounts.<span class="code-method">updateOne</span>(<br>
          &nbsp;&nbsp;{ <span class="code-prop">accountId</span>: <span class="code-string">"A"</span> },<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$inc</span>: { <span class="code-prop">balance</span>: <span class="code-number">-100</span> } },<br>
          &nbsp;&nbsp;{ <span class="code-prop">session</span>: session }<br>
          );<br><br>
          
          accounts.<span class="code-method">updateOne</span>(<br>
          &nbsp;&nbsp;{ <span class="code-prop">accountId</span>: <span class="code-string">"B"</span> },<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$inc</span>: { <span class="code-prop">balance</span>: <span class="code-number">100</span> } },<br>
          &nbsp;&nbsp;{ <span class="code-prop">session</span>: session }<br>
          );<br><br>
          
          <span class="code-comment">// 5. Commit transaction</span><br>
          session.<span class="code-method">commitTransaction</span>();<br><br>
          
          <span class="code-comment">// 6. End session</span><br>
          session.<span class="code-method">endSession</span>();
        </div>

        <div class="section-title">Transaction v·ªõi Error Handling</div>
        <div class="code-block">
          <span class="code-keyword">const</span> session = db.<span class="code-method">getMongo</span>().<span class="code-method">startSession</span>();<br><br>
          
          <span class="code-keyword">try</span> {<br>
          &nbsp;&nbsp;session.<span class="code-method">startTransaction</span>();<br><br>
          
          &nbsp;&nbsp;<span class="code-keyword">const</span> db = session.<span class="code-method">getDatabase</span>(<span class="code-string">"mydb"</span>);<br><br>
          
          &nbsp;&nbsp;<span class="code-comment">// Operations</span><br>
          &nbsp;&nbsp;db.orders.<span class="code-method">insertOne</span>({ ... }, { <span class="code-prop">session</span> });<br>
          &nbsp;&nbsp;db.inventory.<span class="code-method">updateOne</span>({ ... }, { <span class="code-prop">session</span> });<br><br>
          
          &nbsp;&nbsp;session.<span class="code-method">commitTransaction</span>();<br>
          &nbsp;&nbsp;<span class="code-method">print</span>(<span class="code-string">"Transaction committed"</span>);<br>
          } <span class="code-keyword">catch</span> (error) {<br>
          &nbsp;&nbsp;session.<span class="code-method">abortTransaction</span>();<br>
          &nbsp;&nbsp;<span class="code-method">print</span>(<span class="code-string">"Transaction aborted: "</span> + error);<br>
          } <span class="code-keyword">finally</span> {<br>
          &nbsp;&nbsp;session.<span class="code-method">endSession</span>();<br>
          }
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üîÅ</span>
          <span class="card-title">Transaction Options</span>
        </div>
        
        <div class="code-block">
          <span class="code-comment">// Start transaction v·ªõi options</span><br>
          session.<span class="code-method">startTransaction</span>({<br>
          &nbsp;&nbsp;<span class="code-prop">readConcern</span>: { <span class="code-prop">level</span>: <span class="code-string">"snapshot"</span> },<br>
          &nbsp;&nbsp;<span class="code-prop">writeConcern</span>: { <span class="code-prop">w</span>: <span class="code-string">"majority"</span> },<br>
          &nbsp;&nbsp;<span class="code-prop">readPreference</span>: <span class="code-string">"primary"</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">maxCommitTimeMS</span>: <span class="code-number">30000</span><br>
          });
        </div>

        <div class="section-title">Read Concern Levels</div>
        <table class="comparison-table">
          <tr>
            <th>Level</th>
            <th>M√¥ t·∫£</th>
          </tr>
          <tr>
            <td><span class="tag-blue tag">local</span></td>
            <td>ƒê·ªçc d·ªØ li·ªáu m·ªõi nh·∫•t (default)</td>
          </tr>
          <tr>
            <td><span class="tag-green tag">majority</span></td>
            <td>ƒê·ªçc d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c majority acknowledge</td>
          </tr>
          <tr>
            <td><span class="tag-orange tag">snapshot</span></td>
            <td>ƒê·ªçc snapshot t·∫°i th·ªùi ƒëi·ªÉm start transaction</td>
          </tr>
        </table>

        <div class="section-title">Write Concern</div>
        <div class="code-block">
          <span class="code-comment">// Write concern options</span><br>
          {<br>
          &nbsp;&nbsp;<span class="code-prop">w</span>: <span class="code-string">"majority"</span>,  <span class="code-comment">// ho·∫∑c s·ªë: 1, 2, 3...</span><br>
          &nbsp;&nbsp;<span class="code-prop">j</span>: <span class="code-bool">true</span>,          <span class="code-comment">// journal</span><br>
          &nbsp;&nbsp;<span class="code-prop">wtimeout</span>: <span class="code-number">5000</span>    <span class="code-comment">// timeout (ms)</span><br>
          }
        </div>

        <div class="info-box">
          üí° <strong>snapshot</strong> read concern ƒë·∫£m b·∫£o consistent read trong su·ªët transaction
        </div>
      </div>
    </div>

    <!-- Node.js Transactions -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üü¢</span>
          <span class="card-title">Transactions in Node.js</span>
        </div>
        
        <div class="code-block">
          <span class="code-keyword">const</span> { MongoClient } = <span class="code-keyword">require</span>(<span class="code-string">'mongodb'</span>);<br><br>
          
          <span class="code-keyword">async function</span> <span class="code-method">transferMoney</span>(fromAccount, toAccount, amount) {<br>
          &nbsp;&nbsp;<span class="code-keyword">const</span> client = <span class="code-keyword">new</span> MongoClient(uri);<br><br>
          
          &nbsp;&nbsp;<span class="code-keyword">try</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> client.<span class="code-method">connect</span>();<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> session = client.<span class="code-method">startSession</span>();<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">try</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session.<span class="code-method">startTransaction</span>();<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> accounts = client.<span class="code-method">db</span>(<span class="code-string">"bank"</span>).<span class="code-method">collection</span>(<span class="code-string">"accounts"</span>);<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Deduct from sender</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> accounts.<span class="code-method">updateOne</span>(<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">accountId</span>: fromAccount },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-keyword">$inc</span>: { <span class="code-prop">balance</span>: -amount } },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">session</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Add to receiver</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> accounts.<span class="code-method">updateOne</span>(<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">accountId</span>: toAccount },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-keyword">$inc</span>: { <span class="code-prop">balance</span>: amount } },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">session</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> session.<span class="code-method">commitTransaction</span>();<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.<span class="code-method">log</span>(<span class="code-string">"Transaction successful"</span>);<br>
          &nbsp;&nbsp;&nbsp;&nbsp;} <span class="code-keyword">catch</span> (error) {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> session.<span class="code-method">abortTransaction</span>();<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.<span class="code-method">error</span>(<span class="code-string">"Transaction failed:"</span>, error);<br>
          &nbsp;&nbsp;&nbsp;&nbsp;} <span class="code-keyword">finally</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> session.<span class="code-method">endSession</span>();<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;} <span class="code-keyword">finally</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> client.<span class="code-method">close</span>();<br>
          &nbsp;&nbsp;}<br>
          }
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üîÑ</span>
          <span class="card-title">withTransaction Helper</span>
        </div>
        <div class="highlight">
          T·ª± ƒë·ªông retry v√† handle errors
        </div>
        
        <div class="code-block">
          <span class="code-keyword">async function</span> <span class="code-method">transferWithHelper</span>(fromAccount, toAccount, amount) {<br>
          &nbsp;&nbsp;<span class="code-keyword">const</span> client = <span class="code-keyword">new</span> MongoClient(uri);<br><br>
          
          &nbsp;&nbsp;<span class="code-keyword">try</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> client.<span class="code-method">connect</span>();<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> session = client.<span class="code-method">startSession</span>();<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">try</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> session.<span class="code-method">withTransaction</span>(<span class="code-keyword">async</span> () => {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">const</span> accounts = client.<span class="code-method">db</span>(<span class="code-string">"bank"</span>).<span class="code-method">collection</span>(<span class="code-string">"accounts"</span>);<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> accounts.<span class="code-method">updateOne</span>(<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">accountId</span>: fromAccount },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-keyword">$inc</span>: { <span class="code-prop">balance</span>: -amount } },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">session</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> accounts.<span class="code-method">updateOne</span>(<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">accountId</span>: toAccount },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-keyword">$inc</span>: { <span class="code-prop">balance</span>: amount } },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">session</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.<span class="code-method">log</span>(<span class="code-string">"Transaction successful"</span>);<br>
          &nbsp;&nbsp;&nbsp;&nbsp;} <span class="code-keyword">finally</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> session.<span class="code-method">endSession</span>();<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;} <span class="code-keyword">finally</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> client.<span class="code-method">close</span>();<br>
          &nbsp;&nbsp;}<br>
          }
        </div>

        <div class="tip-box">
          ‚úÖ <strong>withTransaction()</strong> t·ª± ƒë·ªông:<br>
          ‚Ä¢ Commit transaction n·∫øu th√†nh c√¥ng<br>
          ‚Ä¢ Abort n·∫øu c√≥ l·ªói<br>
          ‚Ä¢ Retry transient errors
        </div>
      </div>
    </div>

    <!-- Python Transactions -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üêç</span>
          <span class="card-title">Transactions in Python</span>
        </div>
        
        <div class="code-block">
          <span class="code-keyword">from</span> pymongo <span class="code-keyword">import</span> MongoClient<br><br>
          
          <span class="code-keyword">def</span> <span class="code-method">transfer_money</span>(from_account, to_account, amount):<br>
          &nbsp;&nbsp;client = MongoClient(uri)<br><br>
          
          &nbsp;&nbsp;<span class="code-keyword">with</span> client.<span class="code-method">start_session</span>() <span class="code-keyword">as</span> session:<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">with</span> session.<span class="code-method">start_transaction</span>():<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accounts = client.bank.accounts<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment"># Deduct from sender</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accounts.<span class="code-method">update_one</span>(<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="code-string">"accountId"</span>: from_account},<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="code-string">"$inc"</span>: {<span class="code-string">"balance"</span>: -amount}},<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session=session<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment"># Add to receiver</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accounts.<span class="code-method">update_one</span>(<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="code-string">"accountId"</span>: to_account},<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="code-string">"$inc"</span>: {<span class="code-string">"balance"</span>: amount}},<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session=session<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-method">print</span>(<span class="code-string">"Transaction successful"</span>)
        </div>

        <div class="code-block">
          <span class="code-comment"># V·ªõi error handling</span><br>
          <span class="code-keyword">def</span> <span class="code-method">transfer_with_error_handling</span>(from_account, to_account, amount):<br>
          &nbsp;&nbsp;client = MongoClient(uri)<br><br>
          
          &nbsp;&nbsp;<span class="code-keyword">with</span> client.<span class="code-method">start_session</span>() <span class="code-keyword">as</span> session:<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">try</span>:<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session.<span class="code-method">start_transaction</span>()<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accounts = client.bank.accounts<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accounts.<span class="code-method">update_one</span>({...}, session=session)<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accounts.<span class="code-method">update_one</span>({...}, session=session)<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session.<span class="code-method">commit_transaction</span>()<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-method">print</span>(<span class="code-string">"Committed"</span>)<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">except</span> Exception <span class="code-keyword">as</span> e:<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session.<span class="code-method">abort_transaction</span>()<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-method">print</span>(<span class="code-string">f"Aborted: {e}"</span>)
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">‚òï</span>
          <span class="card-title">Transactions in Java</span>
        </div>
        
        <div class="code-block">
          <span class="code-keyword">import</span> com.mongodb.client.*;<br>
          <span class="code-keyword">import</span> com.mongodb.TransactionOptions;<br><br>
          
          <span class="code-keyword">public void</span> <span class="code-method">transferMoney</span>(String from, String to, <span class="code-keyword">int</span> amount) {<br>
          &nbsp;&nbsp;MongoClient client = MongoClients.<span class="code-method">create</span>(uri);<br><br>
          
          &nbsp;&nbsp;ClientSession session = client.<span class="code-method">startSession</span>();<br><br>
          
          &nbsp;&nbsp;<span class="code-keyword">try</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;session.<span class="code-method">startTransaction</span>();<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;MongoCollection&lt;Document&gt; accounts = <br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client.<span class="code-method">getDatabase</span>(<span class="code-string">"bank"</span>)<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.<span class="code-method">getCollection</span>(<span class="code-string">"accounts"</span>);<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Deduct</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;accounts.<span class="code-method">updateOne</span>(session,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(<span class="code-string">"accountId"</span>, from),<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inc(<span class="code-string">"balance"</span>, -amount));<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Add</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;accounts.<span class="code-method">updateOne</span>(session,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eq(<span class="code-string">"accountId"</span>, to),<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inc(<span class="code-string">"balance"</span>, amount));<br><br>
          
          &nbsp;&nbsp;&nbsp;&nbsp;session.<span class="code-method">commitTransaction</span>();<br>
          &nbsp;&nbsp;} <span class="code-keyword">catch</span> (Exception e) {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;session.<span class="code-method">abortTransaction</span>();<br>
          &nbsp;&nbsp;} <span class="code-keyword">finally</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;session.<span class="code-method">close</span>();<br>
          &nbsp;&nbsp;&nbsp;&nbsp;client.<span class="code-method">close</span>();<br>
          &nbsp;&nbsp;}<br>
          }
        </div>
      </div>
    </div>

    <!-- Use Cases & Best Practices -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üí°</span>
          <span class="card-title">When to Use Transactions</span>
        </div>
        
        <div class="section-title">‚úÖ Good Use Cases</div>
        <div class="list-item">Banking: Chuy·ªÉn ti·ªÅn gi·ªØa accounts</div>
        <div class="list-item">E-commerce: Order + Inventory update + Payment</div>
        <div class="list-item">Booking systems: Reserve + Update availability</div>
        <div class="list-item">Multi-step workflows c·∫ßn atomicity</div>
        <div class="list-item">Referential integrity gi·ªØa collections</div>

        <div class="example-box">
          <div class="example-title">Example: E-commerce Order</div>
          <div class="code-block">
            session.<span class="code-method">withTransaction</span>(<span class="code-keyword">async</span> () => {<br>
            &nbsp;&nbsp;<span class="code-comment">// 1. Create order</span><br>
            &nbsp;&nbsp;<span class="code-keyword">await</span> orders.<span class="code-method">insertOne</span>(orderDoc, { session });<br><br>
            
            &nbsp;&nbsp;<span class="code-comment">// 2. Decrease inventory</span><br>
            &nbsp;&nbsp;<span class="code-keyword">await</span> inventory.<span class="code-method">updateOne</span>(<br>
            &nbsp;&nbsp;&nbsp;&nbsp;{ productId },<br>
            &nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-keyword">$inc</span>: { stock: -quantity } },<br>
            &nbsp;&nbsp;&nbsp;&nbsp;{ session }<br>
            &nbsp;&nbsp;);<br><br>
            
            &nbsp;&nbsp;<span class="code-comment">// 3. Process payment</span><br>
            &nbsp;&nbsp;<span class="code-keyword">await</span> payments.<span class="code-method">insertOne</span>(paymentDoc, { session });<br>
            });
          </div>
        </div>

        <div class="section-title">‚ùå Avoid Transactions For</div>
        <div class="list-item">Single document updates (ƒë√£ atomic)</div>
        <div class="list-item">Read-only operations</div>
        <div class="list-item">Bulk inserts (d√πng insertMany)</div>
        <div class="list-item">Long-running operations (timeout risk)</div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">‚ö°</span>
          <span class="card-title">Transaction Best Practices</span>
        </div>
        
        <div class="section-title">‚úÖ DO's</div>
        <div class="list-item">Keep transactions short v√† focused</div>
        <div class="list-item">Limit s·ªë operations trong transaction</div>
        <div class="list-item">Set appropriate timeouts</div>
        <div class="list-item">Handle transient errors v·ªõi retry logic</div>
        <div class="list-item">Use indexes ƒë·ªÉ tƒÉng performance</div>
        <div class="list-item">Test transaction logic thoroughly</div>

        <div class="section-title">‚ùå DON'Ts</div>
        <div class="list-item">Kh√¥ng ch·∫°y long-running operations</div>
        <div class="list-item">Kh√¥ng query qu√° nhi·ªÅu documents</div>
        <div class="list-item">Kh√¥ng nest transactions</div>
        <div class="list-item">Kh√¥ng forget error handling</div>
        <div class="list-item">Kh√¥ng d√πng transactions khi kh√¥ng c·∫ßn</div>

        <div class="warning-box">
          ‚ö†Ô∏è <strong>Transaction Limits:</strong><br>
          ‚Ä¢ Max runtime: 60 seconds (default)<br>
          ‚Ä¢ Max oplog size: 16MB<br>
          ‚Ä¢ Kh√¥ng h·ªó tr·ª£ DDL operations
        </div>

        <div class="tip-box">
          ‚úÖ <strong>Performance Tips:</strong><br>
          ‚Ä¢ D√πng appropriate read/write concerns<br>
          ‚Ä¢ Index c√°c fields ƒë∆∞·ª£c query<br>
          ‚Ä¢ Monitor transaction metrics<br>
          ‚Ä¢ Consider document design ƒë·ªÉ gi·∫£m transactions
        </div>
      </div>
    </div>

    <!-- Error Handling -->
    <div class="grid">
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">üö®</span>
          <span class="card-title">Transaction Error Handling</span>
        </div>
        
        <div class="section-title">Common Transaction Errors</div>
        <table class="comparison-table">
          <tr>
            <th>Error</th>
            <th>Cause</th>
            <th>Solution</th>
          </tr>
          <tr>
            <td><code>TransientTransactionError</code></td>
            <td>Temporary failure (network, lock...)</td>
            <td>Retry entire transaction</td>
          </tr>
          <tr>
            <td><code>UnknownTransactionCommitResult</code></td>
            <td>Commit status unknown</td>
            <td>Retry commit operation</td>
          </tr>
          <tr>
            <td><code>WriteConflict</code></td>
            <td>Concurrent modification</td>
            <td>Retry transaction</td>
          </tr>
          <tr>
            <td><code>NoSuchTransaction</code></td>
            <td>Transaction expired/aborted</td>
            <td>Start new transaction</td>
          </tr>
          <tr>
            <td><code>TransactionTooLarge</code></td>
            <td>Oplog size > 16MB</td>
            <td>Reduce operations or split transaction</td>
          </tr>
        </table>

        <div class="code-block">
          <span class="code-comment">// Retry logic for transient errors</span><br>
          <span class="code-keyword">async function</span> <span class="code-method">runTransactionWithRetry</span>(txnFunc, session) {<br>
          &nbsp;&nbsp;<span class="code-keyword">const</span> maxRetries = <span class="code-number">3</span>;<br>
          &nbsp;&nbsp;<span class="code-keyword">let</span> retries = <span class="code-number">0</span>;<br><br>
          
          &nbsp;&nbsp;<span class="code-keyword">while</span> (retries < maxRetries) {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">try</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> <span class="code-method">txnFunc</span>(session);<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">return</span>; <span class="code-comment">// Success</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;} <span class="code-keyword">catch</span> (error) {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">if</span> (error.<span class="code-prop">hasErrorLabel</span>(<span class="code-string">'TransientTransactionError'</span>)) {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retries++;<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.<span class="code-method">log</span>(<span class="code-string">`Retry ${retries}/${maxRetries}`</span>);<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">await</span> <span class="code-keyword">new</span> <span class="code-method">Promise</span>(r => <span class="code-method">setTimeout</span>(r, <span class="code-number">1000</span>));<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <span class="code-keyword">else</span> {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">throw</span> error;<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br><br>
          
          &nbsp;&nbsp;<span class="code-keyword">throw new</span> <span class="code-method">Error</span>(<span class="code-string">'Transaction failed after retries'</span>);<br>
          }
        </div>
      </div>
    </div>

    <!-- Quick Reference -->
    <div class="grid">
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">üìö</span>
          <span class="card-title">Quick Reference - Transaction Commands</span>
        </div>
        <table class="comparison-table">
          <tr>
            <th>Operation</th>
            <th>mongosh</th>
            <th>Node.js</th>
          </tr>
          <tr>
            <td>Start Session</td>
            <td><code>db.getMongo().startSession()</code></td>
            <td><code>client.startSession()</code></td>
          </tr>
          <tr>
            <td>Start Transaction</td>
            <td><code>session.startTransaction()</code></td>
            <td><code>session.startTransaction()</code></td>
          </tr>
          <tr>
            <td>Commit</td>
            <td><code>session.commitTransaction()</code></td>
            <td><code>await session.commitTransaction()</code></td>
          </tr>
          <tr>
            <td>Abort</td>
            <td><code>session.abortTransaction()</code></td>
            <td><code>await session.abortTransaction()</code></td>
          </tr>
          <tr>
            <td>End Session</td>
            <td><code>session.endSession()</code></td>
            <td><code>await session.endSession()</code></td>
          </tr>
          <tr>
            <td>With Transaction</td>
            <td>N/A</td>
            <td><code>await session.withTransaction(fn)</code></td>
          </tr>
        </table>

        <div class="section-title">Transaction Checklist</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
          <div class="example-box">
            <div class="example-title">Before Transaction</div>
            <div class="list-item">‚úì Replica Set configured</div>
            <div class="list-item">‚úì Indexes created</div>
            <div class="list-item">‚úì Error handling planned</div>
            <div class="list-item">‚úì Timeout configured</div>
          </div>
          <div class="example-box">
            <div class="example-title">During Transaction</div>
            <div class="list-item">‚úì Pass session to operations</div>
            <div class="list-item">‚úì Keep operations minimal</div>
            <div class="list-item">‚úì Handle errors properly</div>
            <div class="list-item">‚úì Monitor performance</div>
          </div>
          <div class="example-box">
            <div class="example-title">After Transaction</div>
            <div class="list-item">‚úì Commit or abort</div>
            <div class="list-item">‚úì End session</div>
            <div class="list-item">‚úì Log results</div>
            <div class="list-item">‚úì Close connections</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>üìö MongoDB Cheat Sheet Series | Part 10 of 16</p>
      <p>Created with Monica AI | December 2024</p>
    </div>
  </div>
</body>
</html>