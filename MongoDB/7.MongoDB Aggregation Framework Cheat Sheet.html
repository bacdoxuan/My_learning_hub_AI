<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MongoDB Cheat Sheet #7 - Aggregation Framework</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      border-radius: 15px;
    }
    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
      color: #1e3c72;
    }
    .header .subtitle {
      color: #1e3c72;
      font-size: 1.1em;
      opacity: 0.9;
    }
    .badge {
      display: inline-block;
      background: rgba(30,60,114,0.3);
      color: #fff;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85em;
      margin-top: 10px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(79,172,254,0.3);
    }
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #4facfe;
    }
    .card-icon {
      font-size: 1.8em;
      margin-right: 12px;
    }
    .card-title {
      font-size: 1.3em;
      color: #4facfe;
    }
    .code-block {
      background: #0d1117;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      overflow-x: auto;
      border-left: 3px solid #4facfe;
    }
    .code-comment {
      color: #6a737d;
    }
    .code-keyword {
      color: #ff7b72;
    }
    .code-string {
      color: #a5d6ff;
    }
    .code-method {
      color: #d2a8ff;
    }
    .code-number {
      color: #79c0ff;
    }
    .code-bool {
      color: #ff7b72;
    }
    .code-prop {
      color: #7ee787;
    }
    .highlight {
      background: linear-gradient(135deg, rgba(79,172,254,0.2), rgba(0,242,254,0.2));
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
    }
    .list-item {
      padding: 8px 0;
      padding-left: 20px;
      position: relative;
    }
    .list-item::before {
      content: "‚ñ∏";
      position: absolute;
      left: 0;
      color: #4facfe;
    }
    .tag {
      display: inline-block;
      background: rgba(79,172,254,0.2);
      color: #4facfe;
      padding: 3px 10px;
      border-radius: 5px;
      font-size: 0.8em;
      margin: 2px;
    }
    .tag-blue {
      background: rgba(33,150,243,0.2);
      color: #64b5f6;
    }
    .tag-green {
      background: rgba(76,175,80,0.2);
      color: #81c784;
    }
    .tag-orange {
      background: rgba(255,152,0,0.2);
      color: #ffb74d;
    }
    .tag-red {
      background: rgba(244,67,54,0.2);
      color: #e57373;
    }
    .tag-purple {
      background: rgba(156,39,176,0.2);
      color: #ce93d8;
    }
    .tag-cyan {
      background: rgba(0,188,212,0.2);
      color: #4dd0e1;
    }
    .full-width {
      grid-column: 1 / -1;
    }
    .info-box {
      background: rgba(33,150,243,0.1);
      border-left: 3px solid #2196f3;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .warning-box {
      background: rgba(244,67,54,0.1);
      border-left: 3px solid #f44336;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .tip-box {
      background: rgba(76,175,80,0.1);
      border-left: 3px solid #4caf50;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .section-title {
      color: #4facfe;
      font-size: 1.1em;
      margin: 15px 0 10px 0;
      padding-bottom: 5px;
      border-bottom: 1px dashed rgba(79,172,254,0.3);
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .comparison-table th, .comparison-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .comparison-table th {
      background: rgba(79,172,254,0.2);
      color: #4facfe;
    }
    .comparison-table tr:hover {
      background: rgba(255,255,255,0.05);
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }
    .example-box {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
    }
    .example-title {
      color: #4facfe;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 0.9em;
    }
    .pipeline-visual {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
    }
    .pipeline-stage {
      display: inline-block;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: #1e3c72;
      padding: 8px 16px;
      border-radius: 8px;
      margin: 5px;
      font-weight: bold;
      font-size: 0.9em;
    }
    .pipeline-arrow {
      display: inline-block;
      color: #4facfe;
      font-size: 1.5em;
      margin: 0 5px;
    }
    .footer {
      text-align: center;
      padding: 20px;
      color: rgba(255,255,255,0.5);
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üçÉ MongoDB Cheat Sheet #7</h1>
      <div class="subtitle">Aggregation Framework</div>
      <div class="badge">üìä Pipeline Stages ‚Ä¢ Operators ‚Ä¢ Advanced Queries</div>
    </div>

    <!-- Aggregation Overview -->
    <div class="grid">
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">üìä</span>
          <span class="card-title">Aggregation Pipeline Overview</span>
        </div>
        <div class="highlight">
          Aggregation Framework x·ª≠ l√Ω documents qua m·ªôt pipeline g·ªìm nhi·ªÅu stages
        </div>
        
        <div class="pipeline-visual">
          <div class="pipeline-stage">Collection</div>
          <span class="pipeline-arrow">‚Üí</span>
          <div class="pipeline-stage">$match</div>
          <span class="pipeline-arrow">‚Üí</span>
          <div class="pipeline-stage">$group</div>
          <span class="pipeline-arrow">‚Üí</span>
          <div class="pipeline-stage">$sort</div>
          <span class="pipeline-arrow">‚Üí</span>
          <div class="pipeline-stage">$project</div>
          <span class="pipeline-arrow">‚Üí</span>
          <div class="pipeline-stage">Result</div>
        </div>

        <table class="comparison-table">
          <tr>
            <th>Category</th>
            <th>Stages</th>
            <th>M√¥ t·∫£</th>
          </tr>
          <tr>
            <td><strong>Filter</strong></td>
            <td><code>$match, $limit, $skip</code></td>
            <td>L·ªçc v√† gi·ªõi h·∫°n documents</td>
          </tr>
          <tr>
            <td><strong>Transform</strong></td>
            <td><code>$project, $addFields, $set, $unset</code></td>
            <td>Bi·∫øn ƒë·ªïi c·∫•u tr√∫c documents</td>
          </tr>
          <tr>
            <td><strong>Group</strong></td>
            <td><code>$group, $bucket, $facet</code></td>
            <td>Nh√≥m v√† t·ªïng h·ª£p d·ªØ li·ªáu</td>
          </tr>
          <tr>
            <td><strong>Sort</strong></td>
            <td><code>$sort, $sortByCount</code></td>
            <td>S·∫Øp x·∫øp k·∫øt qu·∫£</td>
          </tr>
          <tr>
            <td><strong>Join</strong></td>
            <td><code>$lookup, $graphLookup</code></td>
            <td>K·∫øt h·ª£p d·ªØ li·ªáu t·ª´ collections kh√°c</td>
          </tr>
          <tr>
            <td><strong>Array</strong></td>
            <td><code>$unwind, $push, $addToSet</code></td>
            <td>X·ª≠ l√Ω arrays</td>
          </tr>
        </table>

        <div class="code-block">
          <span class="code-comment">// C√∫ ph√°p c∆° b·∫£n</span><br>
          db.collection.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$stage1</span>: { ... } },<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$stage2</span>: { ... } },<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$stage3</span>: { ... } }<br>
          ])
        </div>
      </div>
    </div>

    <!-- $match -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üîç</span>
          <span class="card-title">$match - Filter Documents</span>
        </div>
        <div class="highlight">
          L·ªçc documents gi·ªëng nh∆∞ find() query
        </div>
        
        <div class="code-block">
          <span class="code-comment">// Match ƒë∆°n gi·∫£n</span><br>
          db.orders.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$match</span>: { <span class="code-prop">status</span>: <span class="code-string">"completed"</span> } }<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// Match v·ªõi operators</span><br>
          db.products.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$match</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">price</span>: { <span class="code-keyword">$gte</span>: <span class="code-number">100</span>, <span class="code-keyword">$lte</span>: <span class="code-number">500</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">category</span>: { <span class="code-keyword">$in</span>: [<span class="code-string">"electronics"</span>, <span class="code-string">"books"</span>] }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// Match v·ªõi date range</span><br>
          db.orders.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$match</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">orderDate</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$gte</span>: <span class="code-method">ISODate</span>(<span class="code-string">"2024-01-01"</span>),<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$lt</span>: <span class="code-method">ISODate</span>(<span class="code-string">"2024-12-31"</span>)<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="tip-box">
          ‚úÖ ƒê·∫∑t <strong>$match</strong> s·ªõm nh·∫•t c√≥ th·ªÉ ƒë·ªÉ gi·∫£m documents c·∫ßn x·ª≠ l√Ω<br>
          ‚úÖ <strong>$match</strong> c√≥ th·ªÉ d√πng index
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üìã</span>
          <span class="card-title">$project - Shape Output</span>
        </div>
        <div class="highlight">
          Ch·ªçn fields, t·∫°o computed fields, reshape documents
        </div>
        
        <div class="code-block">
          <span class="code-comment">// Include/exclude fields</span><br>
          db.users.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$project</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">name</span>: <span class="code-number">1</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">email</span>: <span class="code-number">1</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-number">0</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// Computed fields</span><br>
          db.products.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$project</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">name</span>: <span class="code-number">1</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">price</span>: <span class="code-number">1</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">discountPrice</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$multiply</span>: [<span class="code-string">"$price"</span>, <span class="code-number">0.9</span>]<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">total</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$multiply</span>: [<span class="code-string">"$price"</span>, <span class="code-string">"$quantity"</span>]<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// Rename fields</span><br>
          db.users.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$project</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">fullName</span>: <span class="code-string">"$name"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">emailAddress</span>: <span class="code-string">"$email"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">userAge</span>: <span class="code-string">"$age"</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>
      </div>
    </div>

    <!-- $group -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üì¶</span>
          <span class="card-title">$group - Aggregate Data</span>
        </div>
        <div class="highlight">
          Nh√≥m documents v√† t√≠nh to√°n aggregations
        </div>
        
        <div class="code-block">
          <span class="code-comment">// Group by field v√† count</span><br>
          db.orders.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$group</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-string">"$status"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">count</span>: { <span class="code-keyword">$sum</span>: <span class="code-number">1</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])<br>
          <span class="code-comment">// Output: {_id: "completed", count: 150}</span>
        </div>

        <div class="code-block">
          <span class="code-comment">// Multiple aggregations</span><br>
          db.sales.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$group</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-string">"$category"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">totalSales</span>: { <span class="code-keyword">$sum</span>: <span class="code-string">"$amount"</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">avgSale</span>: { <span class="code-keyword">$avg</span>: <span class="code-string">"$amount"</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">maxSale</span>: { <span class="code-keyword">$max</span>: <span class="code-string">"$amount"</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">minSale</span>: { <span class="code-keyword">$min</span>: <span class="code-string">"$amount"</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">count</span>: { <span class="code-keyword">$sum</span>: <span class="code-number">1</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// Group by multiple fields</span><br>
          db.sales.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$group</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">_id</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">category</span>: <span class="code-string">"$category"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">region</span>: <span class="code-string">"$region"</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">total</span>: { <span class="code-keyword">$sum</span>: <span class="code-string">"$amount"</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="flex-row">
          <span class="tag">$sum</span>
          <span class="tag">$avg</span>
          <span class="tag">$min</span>
          <span class="tag">$max</span>
          <span class="tag-blue tag">$first</span>
          <span class="tag-blue tag">$last</span>
          <span class="tag-orange tag">$push</span>
          <span class="tag-orange tag">$addToSet</span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üî¢</span>
          <span class="card-title">$group - Accumulator Operators</span>
        </div>
        
        <div class="code-block">
          <span class="code-comment">// $push - t·∫°o array t·ª´ values</span><br>
          db.orders.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$group</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-string">"$customerId"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">orders</span>: { <span class="code-keyword">$push</span>: <span class="code-string">"$orderId"</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])<br>
          <span class="code-comment">// {_id: "C001", orders: ["O1", "O2", "O3"]}</span>
        </div>

        <div class="code-block">
          <span class="code-comment">// $push object</span><br>
          db.orders.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$group</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-string">"$customerId"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">orderDetails</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$push</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">orderId</span>: <span class="code-string">"$orderId"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">amount</span>: <span class="code-string">"$amount"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">date</span>: <span class="code-string">"$orderDate"</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// $addToSet - unique values only</span><br>
          db.orders.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$group</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-string">"$customerId"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">products</span>: { <span class="code-keyword">$addToSet</span>: <span class="code-string">"$productId"</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// $first & $last</span><br>
          db.sales.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$sort</span>: { <span class="code-prop">date</span>: <span class="code-number">1</span> } },<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$group</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-string">"$productId"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">firstSale</span>: { <span class="code-keyword">$first</span>: <span class="code-string">"$date"</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">lastSale</span>: { <span class="code-keyword">$last</span>: <span class="code-string">"$date"</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>
      </div>
    </div>

    <!-- $sort, $limit, $skip -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üîΩ</span>
          <span class="card-title">$sort, $limit, $skip</span>
        </div>
        
        <div class="section-title">$sort</div>
        <div class="code-block">
          <span class="code-comment">// Sort ascending (1) / descending (-1)</span><br>
          db.products.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$sort</span>: { <span class="code-prop">price</span>: <span class="code-number">-1</span> } }  <span class="code-comment">// Gi√° cao ‚Üí th·∫•p</span><br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// Sort by multiple fields</span><br>
          db.users.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$sort</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">age</span>: <span class="code-number">-1</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">name</span>: <span class="code-number">1</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="section-title">$limit & $skip</div>
        <div class="code-block">
          <span class="code-comment">// Top 10 products</span><br>
          db.products.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$sort</span>: { <span class="code-prop">sales</span>: <span class="code-number">-1</span> } },<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$limit</span>: <span class="code-number">10</span> }<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// Pagination (page 3, 20 items/page)</span><br>
          db.posts.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$sort</span>: { <span class="code-prop">createdAt</span>: <span class="code-number">-1</span> } },<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$skip</span>: <span class="code-number">40</span> },  <span class="code-comment">// (3-1) * 20</span><br>
          &nbsp;&nbsp;{ <span class="code-keyword">$limit</span>: <span class="code-number">20</span> }<br>
          ])
        </div>

        <div class="section-title">$sortByCount</div>
        <div class="code-block">
          <span class="code-comment">// Group v√† sort by count</span><br>
          db.orders.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$sortByCount</span>: <span class="code-string">"$status"</span> }<br>
          ])<br>
          <span class="code-comment">// T∆∞∆°ng ƒë∆∞∆°ng:</span><br>
          <span class="code-comment">// $group: {_id: "$status", count: {$sum: 1}}</span><br>
          <span class="code-comment">// $sort: {count: -1}</span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üîß</span>
          <span class="card-title">$addFields & $set</span>
        </div>
        <div class="highlight">
          Th√™m fields m·ªõi v√†o documents (gi·ªØ nguy√™n fields c≈©)
        </div>
        
        <div class="code-block">
          <span class="code-comment">// $addFields (alias: $set)</span><br>
          db.products.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$addFields</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">discountPrice</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$multiply</span>: [<span class="code-string">"$price"</span>, <span class="code-number">0.9</span>]<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">inStock</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$gt</span>: [<span class="code-string">"$quantity"</span>, <span class="code-number">0</span>]<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// Computed field t·ª´ nhi·ªÅu fields</span><br>
          db.users.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$addFields</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">fullName</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$concat</span>: [<span class="code-string">"$firstName"</span>, <span class="code-string">" "</span>, <span class="code-string">"$lastName"</span>]<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">age</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$subtract</span>: [<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-keyword">$year</span>: <span class="code-keyword">new</span> <span class="code-method">Date</span>() },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-keyword">$year</span>: <span class="code-string">"$birthDate"</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="info-box">
          üí° <strong>$addFields</strong> vs <strong>$project</strong>:<br>
          ‚Ä¢ $addFields: Gi·ªØ t·∫•t c·∫£ fields c≈© + th√™m m·ªõi<br>
          ‚Ä¢ $project: Ch·ªâ gi·ªØ fields ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh
        </div>
      </div>
    </div>

    <!-- $unwind -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üìÇ</span>
          <span class="card-title">$unwind - Deconstruct Arrays</span>
        </div>
        <div class="highlight">
          "M·ªü" array th√†nh nhi·ªÅu documents (1 doc cho m·ªói element)
        </div>
        
        <div class="code-block">
          <span class="code-comment">// Unwind array</span><br>
          db.posts.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$unwind</span>: <span class="code-string">"$tags"</span> }<br>
          ])
        </div>

        <div class="example-box">
          <div class="example-title">Before $unwind:</div>
          <div class="code-block">
            {<br>
            &nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-number">1</span>,<br>
            &nbsp;&nbsp;<span class="code-prop">title</span>: <span class="code-string">"MongoDB Tutorial"</span>,<br>
            &nbsp;&nbsp;<span class="code-prop">tags</span>: [<span class="code-string">"mongodb"</span>, <span class="code-string">"database"</span>, <span class="code-string">"nosql"</span>]<br>
            }
          </div>
          <div class="example-title">After $unwind: "$tags":</div>
          <div class="code-block">
            { <span class="code-prop">_id</span>: <span class="code-number">1</span>, <span class="code-prop">title</span>: <span class="code-string">"MongoDB Tutorial"</span>, <span class="code-prop">tags</span>: <span class="code-string">"mongodb"</span> }<br>
            { <span class="code-prop">_id</span>: <span class="code-number">1</span>, <span class="code-prop">title</span>: <span class="code-string">"MongoDB Tutorial"</span>, <span class="code-prop">tags</span>: <span class="code-string">"database"</span> }<br>
            { <span class="code-prop">_id</span>: <span class="code-number">1</span>, <span class="code-prop">title</span>: <span class="code-string">"MongoDB Tutorial"</span>, <span class="code-prop">tags</span>: <span class="code-string">"nosql"</span> }
          </div>
        </div>

        <div class="code-block">
          <span class="code-comment">// Unwind v·ªõi options</span><br>
          db.posts.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$unwind</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">path</span>: <span class="code-string">"$tags"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">includeArrayIndex</span>: <span class="code-string">"tagIndex"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">preserveNullAndEmptyArrays</span>: <span class="code-bool">true</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// Use case: Count tags frequency</span><br>
          db.posts.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$unwind</span>: <span class="code-string">"$tags"</span> },<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$group</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-string">"$tags"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">count</span>: { <span class="code-keyword">$sum</span>: <span class="code-number">1</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;},<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$sort</span>: { <span class="code-prop">count</span>: <span class="code-number">-1</span> } }<br>
          ])
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üîó</span>
          <span class="card-title">$lookup - Join Collections</span>
        </div>
        <div class="highlight">
          LEFT OUTER JOIN v·ªõi collection kh√°c
        </div>
        
        <div class="code-block">
          <span class="code-comment">// Basic lookup</span><br>
          db.orders.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$lookup</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">from</span>: <span class="code-string">"customers"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">localField</span>: <span class="code-string">"customerId"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">foreignField</span>: <span class="code-string">"_id"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">as</span>: <span class="code-string">"customerInfo"</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="code-block">
          <span class="code-comment">// Lookup v·ªõi pipeline (advanced)</span><br>
          db.orders.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$lookup</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">from</span>: <span class="code-string">"products"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">let</span>: { <span class="code-prop">productId</span>: <span class="code-string">"$productId"</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">pipeline</span>: [<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$match</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$expr</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$eq</span>: [<span class="code-string">"$_id"</span>, <span class="code-string">"$$productId"</span>]<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$project</span>: { <span class="code-prop">name</span>: <span class="code-number">1</span>, <span class="code-prop">price</span>: <span class="code-number">1</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">as</span>: <span class="code-string">"productDetails"</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="info-box">
          üí° <strong>$lookup</strong> tr·∫£ v·ªÅ array, d√πng <strong>$unwind</strong> ƒë·ªÉ flatten n·∫øu c·∫ßn
        </div>
      </div>
    </div>

    <!-- Advanced Stages -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üéØ</span>
          <span class="card-title">$bucket & $facet</span>
        </div>
        
        <div class="section-title">$bucket (Categorize)</div>
        <div class="code-block">
          <span class="code-comment">// Ph√¢n lo·∫°i theo kho·∫£ng gi√°</span><br>
          db.products.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$bucket</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">groupBy</span>: <span class="code-string">"$price"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">boundaries</span>: [<span class="code-number">0</span>, <span class="code-number">50</span>, <span class="code-number">100</span>, <span class="code-number">200</span>, <span class="code-number">500</span>],<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">default</span>: <span class="code-string">"Other"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">output</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">count</span>: { <span class="code-keyword">$sum</span>: <span class="code-number">1</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">products</span>: { <span class="code-keyword">$push</span>: <span class="code-string">"$name"</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>

        <div class="section-title">$facet (Multiple Pipelines)</div>
        <div class="code-block">
          <span class="code-comment">// Ch·∫°y nhi·ªÅu aggregations song song</span><br>
          db.products.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$facet</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">priceStats</span>: [<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$group</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-keyword">null</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">avgPrice</span>: { <span class="code-keyword">$avg</span>: <span class="code-string">"$price"</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">maxPrice</span>: { <span class="code-keyword">$max</span>: <span class="code-string">"$price"</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">topProducts</span>: [<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-keyword">$sort</span>: { <span class="code-prop">sales</span>: <span class="code-number">-1</span> } },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-keyword">$limit</span>: <span class="code-number">5</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">categories</span>: [<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-keyword">$sortByCount</span>: <span class="code-string">"$category"</span> }<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          ])
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üî¢</span>
          <span class="card-title">Expression Operators</span>
        </div>
        
        <div class="section-title">Arithmetic</div>
        <div class="flex-row">
          <span class="tag">$add</span>
          <span class="tag">$subtract</span>
          <span class="tag">$multiply</span>
          <span class="tag">$divide</span>
          <span class="tag">$mod</span>
        </div>

        <div class="code-block">
          <span class="code-comment">// Arithmetic operations</span><br>
          {<br>
          &nbsp;&nbsp;<span class="code-prop">total</span>: { <span class="code-keyword">$multiply</span>: [<span class="code-string">"$price"</span>, <span class="code-string">"$qty"</span>] },<br>
          &nbsp;&nbsp;<span class="code-prop">discount</span>: { <span class="code-keyword">$subtract</span>: [<span class="code-string">"$price"</span>, <span class="code-number">10</span>] }<br>
          }
        </div>

        <div class="section-title">String</div>
        <div class="flex-row">
          <span class="tag-blue tag">$concat</span>
          <span class="tag-blue tag">$substr</span>
          <span class="tag-blue tag">$toLower</span>
          <span class="tag-blue tag">$toUpper</span>
          <span class="tag-blue tag">$split</span>
        </div>

        <div class="code-block">
          <span class="code-comment">// String operations</span><br>
          {<br>
          &nbsp;&nbsp;<span class="code-prop">fullName</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$concat</span>: [<span class="code-string">"$firstName"</span>, <span class="code-string">" "</span>, <span class="code-string">"$lastName"</span>]<br>
          &nbsp;&nbsp;},<br>
          &nbsp;&nbsp;<span class="code-prop">upperName</span>: { <span class="code-keyword">$toUpper</span>: <span class="code-string">"$name"</span> }<br>
          }
        </div>

        <div class="section-title">Date</div>
        <div class="flex-row">
          <span class="tag-orange tag">$year</span>
          <span class="tag-orange tag">$month</span>
          <span class="tag-orange tag">$dayOfMonth</span>
          <span class="tag-orange tag">$hour</span>
          <span class="tag-orange tag">$dateToString</span>
        </div>

        <div class="code-block">
          <span class="code-comment">// Date operations</span><br>
          {<br>
          &nbsp;&nbsp;<span class="code-prop">year</span>: { <span class="code-keyword">$year</span>: <span class="code-string">"$createdAt"</span> },<br>
          &nbsp;&nbsp;<span class="code-prop">formatted</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$dateToString</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">format</span>: <span class="code-string">"%Y-%m-%d"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">date</span>: <span class="code-string">"$createdAt"</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          }
        </div>
      </div>
    </div>

    <!-- Complete Example -->
    <div class="grid">
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">üéì</span>
          <span class="card-title">Complete Example - Sales Analytics</span>
        </div>
        
        <div class="code-block">
          db.orders.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;<span class="code-comment">// 1. Filter orders t·ª´ nƒÉm 2024</span><br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$match</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">orderDate</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$gte</span>: <span class="code-method">ISODate</span>(<span class="code-string">"2024-01-01"</span>),<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$lt</span>: <span class="code-method">ISODate</span>(<span class="code-string">"2025-01-01"</span>)<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">status</span>: <span class="code-string">"completed"</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;},<br><br>
          
          &nbsp;&nbsp;<span class="code-comment">// 2. Join v·ªõi customers</span><br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$lookup</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">from</span>: <span class="code-string">"customers"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">localField</span>: <span class="code-string">"customerId"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">foreignField</span>: <span class="code-string">"_id"</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">as</span>: <span class="code-string">"customer"</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;},<br><br>
          
          &nbsp;&nbsp;<span class="code-comment">// 3. Unwind customer array</span><br>
          &nbsp;&nbsp;{ <span class="code-keyword">$unwind</span>: <span class="code-string">"$customer"</span> },<br><br>
          
          &nbsp;&nbsp;<span class="code-comment">// 4. Add computed fields</span><br>
          &nbsp;&nbsp;{<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-keyword">$addFields</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">month</span>: { <span class="code-keyword">$month</span>: <span class="code-string">"$orderDate"</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">total</span>: {<br>
          &nbsp;&