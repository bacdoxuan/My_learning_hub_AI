<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MongoDB Cheat Sheet #12 - Performance Optimization</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #134e5e 0%, #310f0f 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
      border-radius: 15px;
    }
    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
      color: #134e5e;
    }
    .header .subtitle {
      color: #134e5e;
      font-size: 1.1em;
      opacity: 0.9;
    }
    .badge {
      display: inline-block;
      background: rgba(19,78,94,0.3);
      color: #fff;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.85em;
      margin-top: 10px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(242,153,74,0.3);
    }
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f2994a;
    }
    .card-icon {
      font-size: 1.8em;
      margin-right: 12px;
    }
    .card-title {
      font-size: 1.3em;
      color: #f2c94c;
    }
    .code-block {
      background: #0d1117;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      overflow-x: auto;
      border-left: 3px solid #f2994a;
    }
    .code-comment {
      color: #6a737d;
    }
    .code-keyword {
      color: #ff7b72;
    }
    .code-string {
      color: #a5d6ff;
    }
    .code-method {
      color: #d2a8ff;
    }
    .code-number {
      color: #79c0ff;
    }
    .code-bool {
      color: #ff7b72;
    }
    .code-prop {
      color: #7ee787;
    }
    .highlight {
      background: linear-gradient(135deg, rgba(242,153,74,0.2), rgba(242,201,76,0.2));
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
    }
    .list-item {
      padding: 8px 0;
      padding-left: 20px;
      position: relative;
    }
    .list-item::before {
      content: "‚ñ∏";
      position: absolute;
      left: 0;
      color: #f2c94c;
    }
    .tag {
      display: inline-block;
      background: rgba(242,153,74,0.2);
      color: #f2c94c;
      padding: 3px 10px;
      border-radius: 5px;
      font-size: 0.8em;
      margin: 2px;
    }
    .tag-blue {
      background: rgba(33,150,243,0.2);
      color: #64b5f6;
    }
    .tag-green {
      background: rgba(76,175,80,0.2);
      color: #81c784;
    }
    .tag-orange {
      background: rgba(255,152,0,0.2);
      color: #ffb74d;
    }
    .tag-red {
      background: rgba(244,67,54,0.2);
      color: #e57373;
    }
    .tag-purple {
      background: rgba(156,39,176,0.2);
      color: #ce93d8;
    }
    .full-width {
      grid-column: 1 / -1;
    }
    .info-box {
      background: rgba(33,150,243,0.1);
      border-left: 3px solid #2196f3;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .warning-box {
      background: rgba(244,67,54,0.1);
      border-left: 3px solid #f44336;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .tip-box {
      background: rgba(76,175,80,0.1);
      border-left: 3px solid #4caf50;
      padding: 12px;
      border-radius: 0 8px 8px 0;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .section-title {
      color: #f2c94c;
      font-size: 1.1em;
      margin: 15px 0 10px 0;
      padding-bottom: 5px;
      border-bottom: 1px dashed rgba(242,201,76,0.3);
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .comparison-table th, .comparison-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .comparison-table th {
      background: rgba(242,153,74,0.2);
      color: #f2c94c;
    }
    .comparison-table tr:hover {
      background: rgba(255,255,255,0.05);
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }
    .example-box {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
    }
    .example-title {
      color: #f2c94c;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 0.9em;
    }
    .perf-metric {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .metric-card {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      border-top: 3px solid;
    }
    .metric-card.good { border-color: #4caf50; }
    .metric-card.warning { border-color: #ff9800; }
    .metric-card.bad { border-color: #f44336; }
    .metric-value {
      font-size: 2em;
      font-weight: bold;
      margin: 10px 0;
    }
    .before-after {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 15px 0;
    }
    .before-box {
      background: rgba(244,67,54,0.1);
      border-left: 3px solid #f44336;
      padding: 12px;
      border-radius: 0 8px 8px 0;
    }
    .after-box {
      background: rgba(76,175,80,0.1);
      border-left: 3px solid #4caf50;
      padding: 12px;
      border-radius: 0 8px 8px 0;
    }
    .footer {
      text-align: center;
      padding: 20px;
      color: rgba(255,255,255,0.5);
      font-size: 0.9em;
    }
    @media (max-width: 768px) {
      .before-after, .perf-metric {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üçÉ MongoDB Cheat Sheet #12</h1>
      <div class="subtitle">Performance Optimization</div>
      <div class="badge">‚ö° Indexing ‚Ä¢ Query Optimization ‚Ä¢ Monitoring ‚Ä¢ Best Practices</div>
    </div>

    <!-- Performance Overview -->
    <div class="grid">
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">‚ö°</span>
          <span class="card-title">Performance Optimization Overview</span>
        </div>
        <div class="highlight">
          Performance optimization l√† qu√° tr√¨nh li√™n t·ª•c: <strong>Measure ‚Üí Analyze ‚Üí Optimize ‚Üí Repeat</strong>
        </div>
        
        <div class="perf-metric">
          <div class="metric-card good">
            <div style="font-size: 2em;">üéØ</div>
            <div class="metric-value" style="color: #81c784;">&lt; 100ms</div>
            <strong>Query Time</strong><br>
            <small>Target for most queries</small>
          </div>
          <div class="metric-card good">
            <div style="font-size: 2em;">üìä</div>
            <div class="metric-value" style="color: #81c784;">&gt; 90%</div>
            <strong>Index Hit Rate</strong><br>
            <small>Queries using indexes</small>
          </div>
          <div class="metric-card warning">
            <div style="font-size: 2em;">üíæ</div>
            <div class="metric-value" style="color: #ffb74d;">&lt; 80%</div>
            <strong>RAM Usage</strong><br>
            <small>Working set in memory</small>
          </div>
          <div class="metric-card good">
            <div style="font-size: 2em;">üîÑ</div>
            <div class="metric-value" style="color: #81c784;">&lt; 1000</div>
            <strong>Connections</strong><br>
            <small>Active connections</small>
          </div>
        </div>

        <table class="comparison-table">
          <tr>
            <th>Optimization Area</th>
            <th>Impact</th>
            <th>Difficulty</th>
            <th>Priority</th>
          </tr>
          <tr>
            <td><strong>Indexing</strong></td>
            <td>üî•üî•üî• Very High</td>
            <td>‚≠ê‚≠ê Medium</td>
            <td>üéØ Critical</td>
          </tr>
          <tr>
            <td><strong>Query Optimization</strong></td>
            <td>üî•üî•üî• Very High</td>
            <td>‚≠ê‚≠ê‚≠ê High</td>
            <td>üéØ Critical</td>
          </tr>
          <tr>
            <td><strong>Schema Design</strong></td>
            <td>üî•üî•üî• Very High</td>
            <td>‚≠ê‚≠ê‚≠ê‚≠ê Very High</td>
            <td>üéØ Critical</td>
          </tr>
          <tr>
            <td><strong>Hardware Resources</strong></td>
            <td>üî•üî• High</td>
            <td>‚≠ê Low</td>
            <td>üìå Important</td>
          </tr>
          <tr>
            <td><strong>Connection Pooling</strong></td>
            <td>üî•üî• High</td>
            <td>‚≠ê Low</td>
            <td>üìå Important</td>
          </tr>
          <tr>
            <td><strong>Monitoring</strong></td>
            <td>üî• Medium</td>
            <td>‚≠ê‚≠ê Medium</td>
            <td>üìå Important</td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Query Optimization -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üîç</span>
          <span class="card-title">Query Optimization</span>
        </div>
        
        <div class="section-title">Use explain() to Analyze</div>
        <div class="code-block">
          <span class="code-comment">// Analyze query execution</span><br>
          db.users.<span class="code-method">find</span>({ <span class="code-prop">age</span>: { <span class="code-keyword">$gt</span>: <span class="code-number">25</span> } })<br>
          &nbsp;&nbsp;.<span class="code-method">explain</span>(<span class="code-string">"executionStats"</span>)
        </div>

        <div class="section-title">Key Metrics to Check</div>
        <div class="example-box">
          <div class="code-block" style="margin: 0;">
            {<br>
            &nbsp;&nbsp;<span class="code-prop">executionStats</span>: {<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">executionTimeMillis</span>: <span class="code-number">5</span>,<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">totalDocsExamined</span>: <span class="code-number">100</span>,<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">totalKeysExamined</span>: <span class="code-number">100</span>,<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">nReturned</span>: <span class="code-number">50</span><br>
            &nbsp;&nbsp;},<br>
            &nbsp;&nbsp;<span class="code-prop">winningPlan</span>: {<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">stage</span>: <span class="code-string">"IXSCAN"</span>  <span class="code-comment">// ‚úì Good</span><br>
            &nbsp;&nbsp;}<br>
            }
          </div>
        </div>

        <div class="before-after">
          <div class="before-box">
            <strong style="color: #e57373;">‚ùå Bad Query</strong>
            <div class="code-block" style="margin: 5px 0; font-size: 0.8em;">
              stage: <span class="code-string">"COLLSCAN"</span><br>
              totalDocsExamined: <span class="code-number">1000000</span><br>
              nReturned: <span class="code-number">10</span><br>
              executionTimeMillis: <span class="code-number">5000</span>
            </div>
          </div>
          <div class="after-box">
            <strong style="color: #81c784;">‚úÖ Good Query</strong>
            <div class="code-block" style="margin: 5px 0; font-size: 0.8em;">
              stage: <span class="code-string">"IXSCAN"</span><br>
              totalKeysExamined: <span class="code-number">10</span><br>
              nReturned: <span class="code-number">10</span><br>
              executionTimeMillis: <span class="code-number">2</span>
            </div>
          </div>
        </div>

        <div class="tip-box">
          ‚úÖ <strong>Goal:</strong> totalKeysExamined ‚âà nReturned
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üìä</span>
          <span class="card-title">Query Patterns to Avoid</span>
        </div>
        
        <div class="section-title">‚ùå Avoid $where & $regex without index</div>
        <div class="code-block">
          <span class="code-comment">// BAD: $where (JavaScript execution)</span><br>
          db.users.<span class="code-method">find</span>({<br>
          &nbsp;&nbsp;<span class="code-keyword">$where</span>: <span class="code-string">"this.age > 25"</span><br>
          })<br><br>
          
          <span class="code-comment">// GOOD: Native operators</span><br>
          db.users.<span class="code-method">find</span>({ <span class="code-prop">age</span>: { <span class="code-keyword">$gt</span>: <span class="code-number">25</span> } })
        </div>

        <div class="code-block">
          <span class="code-comment">// BAD: Regex without anchor</span><br>
          db.users.<span class="code-method">find</span>({ <span class="code-prop">name</span>: <span class="code-string">/john/i</span> })<br><br>
          
          <span class="code-comment">// BETTER: Regex with anchor (can use index)</span><br>
          db.users.<span class="code-method">find</span>({ <span class="code-prop">name</span>: <span class="code-string">/^john/i</span> })
        </div>

        <div class="section-title">‚ùå Avoid $ne and $nin when possible</div>
        <div class="code-block">
          <span class="code-comment">// BAD: Scans many documents</span><br>
          db.users.<span class="code-method">find</span>({ <span class="code-prop">status</span>: { <span class="code-keyword">$ne</span>: <span class="code-string">"deleted"</span> } })<br><br>
          
          <span class="code-comment">// BETTER: Use $in with specific values</span><br>
          db.users.<span class="code-method">find</span>({<br>
          &nbsp;&nbsp;<span class="code-prop">status</span>: { <span class="code-keyword">$in</span>: [<span class="code-string">"active"</span>, <span class="code-string">"pending"</span>, <span class="code-string">"suspended"</span>] }<br>
          })
        </div>

        <div class="section-title">‚ùå Avoid large $or with different fields</div>
        <div class="code-block">
          <span class="code-comment">// BAD: Multiple index scans</span><br>
          db.users.<span class="code-method">find</span>({<br>
          &nbsp;&nbsp;<span class="code-keyword">$or</span>: [<br>
          &nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">email</span>: <span class="code-string">"..."</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">username</span>: <span class="code-string">"..."</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">phone</span>: <span class="code-string">"..."</span> }<br>
          &nbsp;&nbsp;]<br>
          })<br><br>
          
          <span class="code-comment">// BETTER: Separate queries or compound index</span>
        </div>
      </div>
    </div>

    <!-- Index Optimization -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üéØ</span>
          <span class="card-title">Index Strategy</span>
        </div>
        
        <div class="section-title">ESR Rule (Equality, Sort, Range)</div>
        <div class="code-block">
          <span class="code-comment">// Query pattern</span><br>
          db.orders.<span class="code-method">find</span>({<br>
          &nbsp;&nbsp;<span class="code-prop">status</span>: <span class="code-string">"completed"</span>,     <span class="code-comment">// Equality</span><br>
          &nbsp;&nbsp;<span class="code-prop">amount</span>: { <span class="code-keyword">$gt</span>: <span class="code-number">100</span> }     <span class="code-comment">// Range</span><br>
          }).<span class="code-method">sort</span>({ <span class="code-prop">createdAt</span>: <span class="code-number">-1</span> })  <span class="code-comment">// Sort</span><br><br>
          
          <span class="code-comment">// Optimal index: E ‚Üí S ‚Üí R</span><br>
          db.orders.<span class="code-method">createIndex</span>({<br>
          &nbsp;&nbsp;<span class="code-prop">status</span>: <span class="code-number">1</span>,        <span class="code-comment">// Equality first</span><br>
          &nbsp;&nbsp;<span class="code-prop">createdAt</span>: <span class="code-number">-1</span>,    <span class="code-comment">// Sort second</span><br>
          &nbsp;&nbsp;<span class="code-prop">amount</span>: <span class="code-number">1</span>         <span class="code-comment">// Range last</span><br>
          })
        </div>

        <div class="section-title">Covered Queries</div>
        <div class="code-block">
          <span class="code-comment">// Create index with all needed fields</span><br>
          db.users.<span class="code-method">createIndex</span>({<br>
          &nbsp;&nbsp;<span class="code-prop">status</span>: <span class="code-number">1</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">age</span>: <span class="code-number">1</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">name</span>: <span class="code-number">1</span><br>
          })<br><br>
          
          <span class="code-comment">// Covered query (no document fetch)</span><br>
          db.users.<span class="code-method">find</span>(<br>
          &nbsp;&nbsp;{ <span class="code-prop">status</span>: <span class="code-string">"active"</span>, <span class="code-prop">age</span>: { <span class="code-keyword">$gt</span>: <span class="code-number">25</span> } },<br>
          &nbsp;&nbsp;{ <span class="code-prop">name</span>: <span class="code-number">1</span>, <span class="code-prop">_id</span>: <span class="code-number">0</span> }  <span class="code-comment">// Must exclude _id</span><br>
          )
        </div>

        <div class="section-title">Index Intersection</div>
        <div class="code-block">
          <span class="code-comment">// MongoDB can use multiple indexes</span><br>
          db.users.<span class="code-method">createIndex</span>({ <span class="code-prop">status</span>: <span class="code-number">1</span> })<br>
          db.users.<span class="code-method">createIndex</span>({ <span class="code-prop">age</span>: <span class="code-number">1</span> })<br><br>
          
          <span class="code-comment">// Query can use both indexes</span><br>
          db.users.<span class="code-method">find</span>({<br>
          &nbsp;&nbsp;<span class="code-prop">status</span>: <span class="code-string">"active"</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">age</span>: { <span class="code-keyword">$gt</span>: <span class="code-number">25</span> }<br>
          })<br><br>
          
          <span class="code-comment">// But compound index is usually better</span><br>
          db.users.<span class="code-method">createIndex</span>({ <span class="code-prop">status</span>: <span class="code-number">1</span>, <span class="code-prop">age</span>: <span class="code-number">1</span> })
        </div>

        <div class="warning-box">
          ‚ö†Ô∏è Too many indexes slow down writes. Balance read vs write performance.
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üîß</span>
          <span class="card-title">Index Maintenance</span>
        </div>
        
        <div class="section-title">Find Unused Indexes</div>
        <div class="code-block">
          <span class="code-comment">// Check index usage statistics</span><br>
          db.users.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$indexStats</span>: {} }<br>
          ])<br><br>
          
          <span class="code-comment">// Output shows:</span><br>
          {<br>
          &nbsp;&nbsp;<span class="code-prop">name</span>: <span class="code-string">"status_1_age_1"</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">accesses</span>: {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">ops</span>: <span class="code-number">1000</span>,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">since</span>: <span class="code-method">ISODate</span>(<span class="code-string">"..."</span>)<br>
          &nbsp;&nbsp;}<br>
          }
        </div>

        <div class="code-block">
          <span class="code-comment">// Find indexes with 0 usage</span><br>
          db.users.<span class="code-method">aggregate</span>([<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$indexStats</span>: {} },<br>
          &nbsp;&nbsp;{ <span class="code-keyword">$match</span>: { <span class="code-string">"accesses.ops"</span>: <span class="code-number">0</span> } }<br>
          ])
        </div>

        <div class="section-title">Drop Unused Indexes</div>
        <div class="code-block">
          <span class="code-comment">// Drop specific index</span><br>
          db.users.<span class="code-method">dropIndex</span>(<span class="code-string">"unused_index_name"</span>)<br><br>
          
          <span class="code-comment">// List all indexes first</span><br>
          db.users.<span class="code-method">getIndexes</span>()
        </div>

        <div class="section-title">Rebuild Indexes</div>
        <div class="code-block">
          <span class="code-comment">// Rebuild all indexes (maintenance window)</span><br>
          db.users.<span class="code-method">reIndex</span>()<br><br>
          
          <span class="code-comment">// Or drop and recreate specific index</span><br>
          db.users.<span class="code-method">dropIndex</span>(<span class="code-string">"old_index"</span>)<br>
          db.users.<span class="code-method">createIndex</span>({ <span class="code-prop">field</span>: <span class="code-number">1</span> })
        </div>

        <div class="tip-box">
          ‚úÖ Review index usage monthly and remove unused indexes
        </div>
      </div>
    </div>

    <!-- Schema Design -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üìê</span>
          <span class="card-title">Schema Design Patterns</span>
        </div>
        
        <div class="section-title">Embedding vs Referencing</div>
        <div class="before-after">
          <div class="before-box">
            <strong>‚ùå Bad: Deep Nesting</strong>
            <div class="code-block" style="margin: 5px 0; font-size: 0.75em;">
              {<br>
              &nbsp;&nbsp;user: {<br>
              &nbsp;&nbsp;&nbsp;&nbsp;profile: {<br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;address: {<br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;city: {<br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: <span class="code-string">"..."</span><br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
              &nbsp;&nbsp;&nbsp;&nbsp;}<br>
              &nbsp;&nbsp;}<br>
              }
            </div>
          </div>
          <div class="after-box">
            <strong>‚úÖ Good: Flat Structure</strong>
            <div class="code-block" style="margin: 5px 0; font-size: 0.75em;">
              {<br>
              &nbsp;&nbsp;userId: <span class="code-string">"..."</span>,<br>
              &nbsp;&nbsp;profileId: <span class="code-string">"..."</span>,<br>
              &nbsp;&nbsp;addressCity: <span class="code-string">"..."</span>,<br>
              &nbsp;&nbsp;addressCountry: <span class="code-string">"..."</span><br>
              }
            </div>
          </div>
        </div>

        <div class="section-title">Embed When:</div>
        <div class="list-item">One-to-one relationships</div>
        <div class="list-item">One-to-few relationships</div>
        <div class="list-item">Data accessed together</div>
        <div class="list-item">Data doesn't change frequently</div>

        <div class="section-title">Reference When:</div>
        <div class="list-item">One-to-many relationships</div>
        <div class="list-item">Many-to-many relationships</div>
        <div class="list-item">Data grows unbounded</div>
        <div class="list-item">Data accessed independently</div>

        <div class="example-box">
          <div class="example-title">Example: Blog Post</div>
          <div class="code-block">
            {<br>
            &nbsp;&nbsp;<span class="code-prop">_id</span>: <span class="code-method">ObjectId</span>(<span class="code-string">"..."</span>),<br>
            &nbsp;&nbsp;<span class="code-prop">title</span>: <span class="code-string">"MongoDB Performance"</span>,<br>
            &nbsp;&nbsp;<span class="code-prop">author</span>: {  <span class="code-comment">// Embed (1-to-1)</span><br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">name</span>: <span class="code-string">"John"</span>,<br>
            &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-prop">email</span>: <span class="code-string">"john@example.com"</span><br>
            &nbsp;&nbsp;},<br>
            &nbsp;&nbsp;<span class="code-prop">tags</span>: [<span class="code-string">"mongodb"</span>, <span class="code-string">"performance"</span>],  <span class="code-comment">// Embed (1-to-few)</span><br>
            &nbsp;&nbsp;<span class="code-prop">commentIds</span>: [...]  <span class="code-comment">// Reference (1-to-many)</span><br>
            }
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üé®</span>
          <span class="card-title">Advanced Schema Patterns</span>
        </div>
        
        <div class="section-title">Bucket Pattern</div>
        <div class="code-block">
          <span class="code-comment">// For time-series or IoT data</span><br>
          {<br>
          &nbsp;&nbsp;<span class="code-prop">sensorId</span>: <span class="code-string">"sensor_1"</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">date</span>: <span class="code-method">ISODate</span>(<span class="code-string">"2024-12-24"</span>),<br>
          &nbsp;&nbsp;<span class="code-prop">readings</span>: [<br>
          &nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">time</span>: <span class="code-string">"00:00"</span>, <span class="code-prop">temp</span>: <span class="code-number">20</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">time</span>: <span class="code-string">"00:01"</span>, <span class="code-prop">temp</span>: <span class="code-number">21</span> },<br>
          &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// ... 1440 readings per day</span><br>
          &nbsp;&nbsp;]<br>
          }
        </div>

        <div class="section-title">Computed Pattern</div>
        <div class="code-block">
          <span class="code-comment">// Pre-calculate frequently accessed values</span><br>
          {<br>
          &nbsp;&nbsp;<span class="code-prop">orderId</span>: <span class="code-string">"..."</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">items</span>: [...],<br>
          &nbsp;&nbsp;<span class="code-prop">totalAmount</span>: <span class="code-number">150</span>,     <span class="code-comment">// Pre-calculated</span><br>
          &nbsp;&nbsp;<span class="code-prop">itemCount</span>: <span class="code-number">3</span>,         <span class="code-comment">// Pre-calculated</span><br>
          &nbsp;&nbsp;<span class="code-prop">taxAmount</span>: <span class="code-number">15</span>         <span class="code-comment">// Pre-calculated</span><br>
          }
        </div>

        <div class="section-title">Subset Pattern</div>
        <div class="code-block">
          <span class="code-comment">// Store frequently accessed subset</span><br>
          {<br>
          &nbsp;&nbsp;<span class="code-prop">productId</span>: <span class="code-string">"..."</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">name</span>: <span class="code-string">"Laptop"</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">recentReviews</span>: [  <span class="code-comment">// Last 10 reviews</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;{ <span class="code-prop">rating</span>: <span class="code-number">5</span>, <span class="code-prop">text</span>: <span class="code-string">"..."</span> }<br>
          &nbsp;&nbsp;],<br>
          &nbsp;&nbsp;<span class="code-prop">allReviewsCount</span>: <span class="code-number">1500</span>  <span class="code-comment">// Total count</span><br>
          }
        </div>

        <div class="tip-box">
          ‚úÖ Choose patterns based on access patterns, not just data relationships
        </div>
      </div>
    </div>

    <!-- Connection Pooling -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üîå</span>
          <span class="card-title">Connection Pooling</span>
        </div>
        <div class="highlight">
          Reuse connections thay v√¨ t·∫°o m·ªõi m·ªói request
        </div>
        
        <div class="section-title">Node.js Connection Pool</div>
        <div class="code-block">
          <span class="code-keyword">const</span> { MongoClient } = <span class="code-keyword">require</span>(<span class="code-string">'mongodb'</span>);<br><br>
          
          <span class="code-keyword">const</span> client = <span class="code-keyword">new</span> MongoClient(uri, {<br>
          &nbsp;&nbsp;<span class="code-prop">maxPoolSize</span>: <span class="code-number">50</span>,        <span class="code-comment">// Max connections</span><br>
          &nbsp;&nbsp;<span class="code-prop">minPoolSize</span>: <span class="code-number">10</span>,        <span class="code-comment">// Min connections</span><br>
          &nbsp;&nbsp;<span class="code-prop">maxIdleTimeMS</span>: <span class="code-number">30000</span>,   <span class="code-comment">// Close idle after 30s</span><br>
          &nbsp;&nbsp;<span class="code-prop">waitQueueTimeoutMS</span>: <span class="code-number">5000</span> <span class="code-comment">// Wait 5s for connection</span><br>
          });<br><br>
          
          <span class="code-keyword">await</span> client.<span class="code-method">connect</span>();
        </div>

        <div class="section-title">Python Connection Pool</div>
        <div class="code-block">
          <span class="code-keyword">from</span> pymongo <span class="code-keyword">import</span> MongoClient<br><br>
          
          client = MongoClient(<br>
          &nbsp;&nbsp;uri,<br>
          &nbsp;&nbsp;maxPoolSize=<span class="code-number">50</span>,<br>
          &nbsp;&nbsp;minPoolSize=<span class="code-number">10</span>,<br>
          &nbsp;&nbsp;maxIdleTimeMS=<span class="code-number">30000</span><br>
          )
        </div>

        <div class="section-title">Recommended Pool Sizes</div>
        <table class="comparison-table">
          <tr>
            <th>Application Type</th>
            <th>Pool Size</th>
          </tr>
          <tr>
            <td>Small app (&lt; 100 users)</td>
            <td>10-20</td>
          </tr>
          <tr>
            <td>Medium app (100-1000 users)</td>
            <td>20-50</td>
          </tr>
          <tr>
            <td>Large app (&gt; 1000 users)</td>
            <td>50-100</td>
          </tr>
        </table>

        <div class="warning-box">
          ‚ö†Ô∏è Too many connections waste resources. Monitor and adjust based on actual usage.
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">‚öôÔ∏è</span>
          <span class="card-title">Read/Write Concerns</span>
        </div>
        
        <div class="section-title">Read Concern</div>
        <div class="code-block">
          <span class="code-comment">// local (default) - fastest</span><br>
          db.users.<span class="code-method">find</span>({...}).<span class="code-method">readConcern</span>(<span class="code-string">"local"</span>)<br><br>
          
          <span class="code-comment">// majority - consistent reads</span><br>
          db.users.<span class="code-method">find</span>({...}).<span class="code-method">readConcern</span>(<span class="code-string">"majority"</span>)<br><br>
          
          <span class="code-comment">// linearizable - strongest consistency</span><br>
          db.users.<span class="code-method">find</span>({...}).<span class="code-method">readConcern</span>(<span class="code-string">"linearizable"</span>)
        </div>

        <div class="section-title">Write Concern</div>
        <div class="code-block">
          <span class="code-comment">// w: 1 (default) - fastest</span><br>
          db.users.<span class="code-method">insertOne</span>(doc, { <span class="code-prop">writeConcern</span>: { <span class="code-prop">w</span>: <span class="code-number">1</span> } })<br><br>
          
          <span class="code-comment">// w: "majority" - durable</span><br>
          db.users.<span class="code-method">insertOne</span>(doc, {<br>
          &nbsp;&nbsp;<span class="code-prop">writeConcern</span>: { <span class="code-prop">w</span>: <span class="code-string">"majority"</span>, <span class="code-prop">j</span>: <span class="code-bool">true</span> }<br>
          })
        </div>

        <div class="section-title">Trade-offs</div>
        <table class="comparison-table">
          <tr>
            <th>Concern</th>
            <th>Speed</th>
            <th>Consistency</th>
          </tr>
          <tr>
            <td>local / w:1</td>
            <td>‚ö°‚ö°‚ö° Fastest</td>
            <td>‚≠ê Eventual</td>
          </tr>
          <tr>
            <td>majority / w:majority</td>
            <td>‚ö°‚ö° Medium</td>
            <td>‚≠ê‚≠ê‚≠ê Strong</td>
          </tr>
          <tr>
            <td>linearizable / w:all</td>
            <td>‚ö° Slowest</td>
            <td>‚≠ê‚≠ê‚≠ê‚≠ê Strongest</td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Monitoring -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üìä</span>
          <span class="card-title">Performance Monitoring</span>
        </div>
        
        <div class="section-title">Database Profiler</div>
        <div class="code-block">
          <span class="code-comment">// Enable profiler (level 1 = slow queries)</span><br>
          db.<span class="code-method">setProfilingLevel</span>(<span class="code-number">1</span>, { <span class="code-prop">slowms</span>: <span class="code-number">100</span> })<br><br>
          
          <span class="code-comment">// Level 0 = off, 1 = slow only, 2 = all</span><br><br>
          
          <span class="code-comment">// View slow queries</span><br>
          db.system.profile.<span class="code-method">find</span>().<span class="code-method">sort</span>({ <span class="code-prop">ts</span>: <span class="code-number">-1</span> }).<span class="code-method">limit</span>(<span class="code-number">10</span>)
        </div>

        <div class="section-title">Server Status</div>
        <div class="code-block">
          <span class="code-comment">// Get server statistics</span><br>
          db.<span class="code-method">serverStatus</span>()<br><br>
          
          <span class="code-comment">// Key metrics to monitor:</span><br>
          {<br>
          &nbsp;&nbsp;<span class="code-prop">connections</span>: { <span class="code-prop">current</span>: <span class="code-number">50</span>, <span class="code-prop">available</span>: <span class="code-number">950</span> },<br>
          &nbsp;&nbsp;<span class="code-prop">opcounters</span>: { <span class="code-prop">query</span>: <span class="code-number">1000</span>, <span class="code-prop">insert</span>: <span class="code-number">500</span> },<br>
          &nbsp;&nbsp;<span class="code-prop">mem</span>: { <span class="code-prop">resident</span>: <span class="code-number">1024</span>, <span class="code-prop">virtual</span>: <span class="code-number">2048</span> },<br>
          &nbsp;&nbsp;<span class="code-prop">wiredTiger</span>: { <span class="code-prop">cache</span>: {...} }<br>
          }
        </div>

        <div class="section-title">Current Operations</div>
        <div class="code-block">
          <span class="code-comment">// View running operations</span><br>
          db.<span class="code-method">currentOp</span>()<br><br>
          
          <span class="code-comment">// Find long-running queries</span><br>
          db.<span class="code-method">currentOp</span>({<br>
          &nbsp;&nbsp;<span class="code-string">"active"</span>: <span class="code-bool">true</span>,<br>
          &nbsp;&nbsp;<span class="code-string">"secs_running"</span>: { <span class="code-keyword">$gt</span>: <span class="code-number">5</span> }<br>
          })
        </div>

        <div class="section-title">Kill Long Operations</div>
        <div class="code-block">
          <span class="code-comment">// Kill specific operation</span><br>
          db.<span class="code-method">killOp</span>(<span class="code-number">12345</span>)  <span class="code-comment">// opid from currentOp()</span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">üìà</span>
          <span class="card-title">Key Metrics to Monitor</span>
        </div>
        
        <div class="section-title">Performance Metrics</div>
        <div class="list-item">Query execution time (< 100ms target)</div>
        <div class="list-item">Index hit rate (> 90% target)</div>
        <div class="list-item">Page faults (should be low)</div>
        <div class="list-item">Lock percentage (< 10% target)</div>
        <div class="list-item">Replication lag (< 1s target)</div>

        <div class="section-title">Resource Metrics</div>
        <div class="list-item">CPU usage (< 80% sustained)</div>
        <div class="list-item">Memory usage (working set in RAM)</div>
        <div class="list-item">Disk I/O (IOPS, throughput)</div>
        <div class="list-item">Network bandwidth</div>
        <div class="list-item">Connection count</div>

        <div class="section-title">Database Stats</div>
        <div class="code-block">
          <span class="code-comment">// Database statistics</span><br>
          db.<span class="code-method">stats</span>()<br><br>
          
          {<br>
          &nbsp;&nbsp;<span class="code-prop">dataSize</span>: <span class="code-number">1000000000</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">storageSize</span>: <span class="code-number">1200000000</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">indexes</span>: <span class="code-number">10</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">indexSize</span>: <span class="code-number">50000000</span>,<br>
          &nbsp;&nbsp;<span class="code-prop">avgObjSize</span>: <span class="code-number">1024</span><br>
          }
        </div>

        <div class="code-block">
          <span class="code-comment">// Collection statistics</span><br>
          db.users.<span class="code-method">stats</span>()
        </div>
      </div>
    </div>

    <!-- Hardware & Configuration -->
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">üíª</span>
          <span class="card-title">Hardware Optimization</span>
        </div>
        
        <div class="section-title">RAM Requirements</div>
        <div class="example-box">
          <strong>Working Set in RAM</strong><br>
          <div style="margin-top: 10px;">
            Working Set = Frequently accessed data + indexes<br><br>
            <strong>Formula:</strong><br>
            RAM ‚â• Working Set + OS + MongoDB overhead<br><br>
            <strong>Example:</strong><br>
            ‚Ä¢ Working Set: 8GB<br>
            ‚Ä¢ OS: 2GB<br>
            ‚Ä¢ MongoDB: 2GB<br>
            ‚Ä¢ <strong>Total: 12GB minimum</strong>
          </div>
        </div>

        <div class="section-title">Storage</div>
        <div class="list-item">Use SSD for production (10-100x faster than HDD)</div>
        <div class="list-item">Separate data and journal on different disks</div>
        <div class="list-item">RAID 10 for redundancy and performance</div>
        <div class="list-item">XFS or ext4 filesystem (Linux)</div>

        <div class="section-title">CPU</div>
        <div class="list-item">More cores better than higher clock speed</div>
        <div class="list-item">4-8 cores minimum for production</div>
        <div class="list-item">Scale horizontally with sharding for CPU-bound workloads</div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">‚öôÔ∏è</span>
          <span class="card-title">MongoDB Configuration</span>
        </div>
        
        <div class="section-title">WiredTiger Cache</div>
        <div class="code-block">
          <span class="code-comment"># mongod.conf</span><br>
          storage:<br>
          &nbsp;&nbsp;wiredTiger:<br>
          &nbsp;&nbsp;&nbsp;&nbsp;engineConfig:<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cacheSizeGB: <span class="code-number">4</span><br><br>
          
          <span class="code-comment"># Default: 50% of RAM - 1GB</span><br>
          <span class="code-comment"># Or: 256MB (whichever is larger)</span>
        </div>

        <div class="section-title">Journal Settings</div>
        <div class="code-block">
          <span class="code-comment"># mongod.conf</span><br>
          storage:<br>
          &nbsp;&nbsp;journal:<br>
          &nbsp;&nbsp;&nbsp;&nbsp;enabled: <span class="code-bool">true</span><br>
          &nbsp;&nbsp;&nbsp;&nbsp;commitIntervalMs: <span class="code-number">100</span>  <span class="code-comment"># Default</span>
        </div>

        <div class="section-title">Connection Settings</div>
        <div class="code-block">
          <span class="code-comment"># mongod.conf</span><br>
          net:<br>
          &nbsp;&nbsp;maxIncomingConnections: <span class="code-number">1000</span><br>
          &nbsp;&nbsp;compression:<br>
          &nbsp;&nbsp;&nbsp;&nbsp;compressors: snappy  <span class="code-comment"># or zstd, zlib</span>
        </div>

        <div class="section-title">Operation Profiling</div>
        <div class="code-block">
          <span class="code-comment"># mongod.conf</span><br>
          operationProfiling:<br>
          &nbsp;&nbsp;mode: slowOp<br>
          &nbsp;&nbsp;slowOpThresholdMs: <span class="code-number">100</span>
        </div>
      </div>
    </div>

    <!-- Best Practices Summary -->
    <div class="grid">
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">‚≠ê</span>
          <span class="card-title">Performance Best Practices Summary</span>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
          <div>
            <div class="section-title">‚úÖ Indexing</div>
            <div class="list-item">Create indexes for frequent queries</div>
            <div class="list-item">Follow ESR rule (Equality, Sort, Range)</div>
            <div class="list-item">Use covered queries when possible</div>
            <div class="list-item">Remove unused indexes</div>
            <div class="list-item">Monitor index usage with $indexStats</div>
          </div>
          
          <div>
            <div class="section-title">‚úÖ Query Optimization</div>
            <div class="list-item">Use explain() to analyze queries</div>
            <div class="list-item">Avoid $where and unanchored $regex</div>
            <div class="list-item">Limit result sets with limit()</div>
            <div class="list-item">Project only needed fields</div>
            <div class="list-item">Use aggregation pipeline efficiently</div>
          </div>
          
          <div>
            <div class="section-title">‚úÖ Schema Design</div>
            <div class="list-item">Design for access patterns</div>
            <div class="list-item">Embed for 1-to-1 and 1-to-few</div>
            <div class="list-item">Reference for 1-to-many</div>
            <div class="list-item">Avoid deep nesting (> 3 levels)</div>
            <div class="list-item">Pre-calculate frequently used values</div>
          </div>
          
          <div>
            <div class="section-title">‚úÖ Application</div>
            <div class="list-item">Use connection pooling</div>
            <div class="list-item">Implement caching layer (Redis)</div>
            <div class="list-item">Batch operations when possible</div>
            <div class="list-item">Use appropriate read/write concerns</div>
            <div class="list-item">Handle errors and retries</div>
          </div>
          
          <div>
            <div class="section-title">‚úÖ Monitoring</div>
            <div class="list-item">Enable slow query logging</div>
            <div class="list-item">Monitor key metrics regularly</div>
            <div class="list-item">Set up alerts for anomalies</div>
            <div class="list-item">Review performance weekly</div>
            <div class="list-item">Use MongoDB Atlas monitoring</div>
          </div>
          
          <div>
            <div class="section-title">‚úÖ Hardware</div>
            <div class="list-item">Ensure working set fits in RAM</div>
            <div class="list-item">Use SSD for production</div>
            <div class="list-item">Adequate CPU cores (4-8+)</div>
            <div class="list-item">Fast network (1Gbps+)</div>
            <div class="list-item">Plan for growth (2x capacity)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Reference -->
    <div class="grid">
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">üìö</span>
          <span class="card-title">Quick Reference - Performance Commands</span>
        </div>
        <table class="comparison-table">
          <tr>
            <th>Task</th>
            <th>Command</th>
            <th>Purpose</th>
          </tr>
          <tr>
            <td>Analyze Query</td>
            <td><code>db.col.find().explain("executionStats")</code></td>
            <td>Query performance analysis</td>
          </tr>
          <tr>
            <td>Index Usage</td>
            <td><code>db.col.aggregate([{$indexStats:{}}])</code></td>
            <td>Check index usage statistics</td>
          </tr>
          <tr>
            <td>Slow Queries</td>
            <td><code>db.system.profile.find().sort({ts:-1})</code></td>
            <td>View profiled slow queries</td>
          </tr>
          <tr>
            <td>Server Status</td>
            <td><code>db.serverStatus()</code></td>
            <td>Server metrics and statistics</td>
          </tr>
          <tr>
            <td>Current Ops</td>
            <td><code>db.currentOp()</code></td>
            <td>View running operations</td>
          </tr>
          <tr>
            <td>DB Stats</td>
            <td><code>db.stats()</code></td>
            <td>Database statistics</td>
          </tr>
          <tr>
            <td>Collection Stats</td>
            <td><code>db.col.stats()</code></td>
            <td>Collection statistics</td>
          </tr>
          <tr>
            <td>Enable Profiler</td>
            <td><code>db.setProfilingLevel(1, {slowms:100})</code></td>
            <td>Log slow queries</td>
          </tr>
          <tr>
            <td>Kill Operation</td>
            <td><code>db.killOp(opid)</code></td>
            <td>Terminate long operation</t